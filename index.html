<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study Log & Flashcards</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
<style>
body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
#sidebar { width: 220px; background: #f0f0f0; padding: 16px; overflow-y: auto; box-sizing: border-box; }
#content { flex: 1; padding: 20px; overflow-y: auto; position: relative; scroll-behavior: smooth; box-sizing: border-box; }

.folder { margin-bottom: 12px; }
.folder-title { cursor: pointer; margin-bottom: 6px; font-weight: bold; user-select: none; display: flex; align-items: center; }
.folder-title::before { content: "►"; display: inline-block; width: 14px; margin-right: 6px; transition: transform 0.2s ease; }
.folder.open .folder-title::before { transform: rotate(90deg); }
.folder-content { display: none; margin-left: 6px; }
.folder.open .folder-content { display: block; }

.file-item { cursor: pointer; padding: 6px 8px; border-radius: 6px; margin-bottom: 6px; transition: background 0.14s, font-weight 0.14s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.file-item:hover { background: white; font-weight: bold; }

#self-study-btn, #calendar-btn {
  position: fixed; top: 12px; right: 12px;
  background: #222; color: #fff; border: 1px solid #555;
  padding: 8px 12px; border-radius: 6px; cursor: pointer; z-index: 1000;
}
#calendar-btn { top: 50px; }

#self-study-page, #calendar-page {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.95); color: white;
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  opacity: 0; pointer-events: none; transition: opacity 0.32s ease; z-index: 999;
  padding: 40px; box-sizing: border-box; overflow-y: auto;
}
#self-study-page.visible, #calendar-page.visible { opacity: 1; pointer-events: auto; }

.status-square { display:inline-block; width:15px; height:15px; margin-right:8px; vertical-align:middle; }
section.day-section { margin-bottom: 40px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
.flashcard-card { border:1px solid #ccc; padding:10px; border-radius:6px; background:#fff; cursor:pointer; }
.flashcard-card .a { display:none; margin-top:6px; }
.calendar-month { margin-bottom: 20px; width:100%; max-width:960px; }
.calendar-month h3 { margin-bottom:8px; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 28px); gap:4px; }
.calendar-day { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:50%; font-size:12px; cursor:pointer; }
.calendar-day.gold { background: gold; color: black; }
.calendar-day.green { background: lightgreen; color: black; }
.calendar-day.red { background: #ff5c5c; color: white; }
</style>
</head>
<body>

<div id="sidebar"></div>
<div id="content" tabindex="0"></div>
<button id="self-study-btn">Self-Study Stats</button>
<button id="calendar-btn">Calendar</button>

<div id="self-study-page" aria-hidden="true">
  <h1 id="ss-day-count" style="font-size:48px; margin-bottom:18px;"></h1>
  <h2 id="ss-total-cards" style="font-size:32px; margin-bottom:28px;"></h2>
  <div id="ss-plans" style="font-size:18px; max-width:760px;"></div>
</div>

<div id="calendar-page" aria-hidden="true">
  <h1 style="margin-bottom:24px;">Study Calendar</h1>
  <div id="calendar-container"></div>
  <button id="calendar-close" style="margin-top:24px; padding:8px 12px; border-radius:6px; border:1px solid #555; background:#222; color:#fff; cursor:pointer;">Close</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const sidebar = document.getElementById("sidebar");
  const content = document.getElementById("content");
  const selfStudyBtn = document.getElementById("self-study-btn");
  const selfStudyPage = document.getElementById("self-study-page");
  const calendarBtn = document.getElementById("calendar-btn");
  const calendarPage = document.getElementById("calendar-page");
  const calendarContainer = document.getElementById("calendar-container");
  const calendarClose = document.getElementById("calendar-close");

  const studyData = await fetch("study_log.json").then(r => r.json());
  const knownAuthors = ["Stewart","Lay","Velleman","Vellerman","Abbott","Friedberg","Kleppner"];

  function extractAuthors(topics) {
    const authors = new Set();
    for (const t of topics) {
      for (const k of knownAuthors) {
        if (new RegExp("\\b"+k.replace(/[:]/g,"")+"\\b","i").test(t)) authors.add(k);
      }
    }
    return authors.size ? [...authors].join("+") : "<b>Rest Day</b>";
  }

  function createFolder(titleText, listItemsFunc) {
    const folder = document.createElement("div");
    folder.className = "folder";
    const title = document.createElement("div");
    title.className = "folder-title";
    title.textContent = titleText;
    folder.appendChild(title);
    const contentDiv = document.createElement("div");
    contentDiv.className = "folder-content";
    folder.appendChild(contentDiv);
    sidebar.appendChild(folder);
    title.addEventListener("click", () => folder.classList.toggle("open"));
    listItemsFunc(contentDiv);
  }

  // Study Log
  createFolder("Study Log", container => {
    studyData.forEach(entry => {
      const item = document.createElement("div");
      item.className = "file-item";
      item.textContent = `Day ${entry.day} — ${entry.date}`;
      item.addEventListener("click", () => { showFullStudyLog(); scrollToDay(entry.day); });
      container.appendChild(item);
    });
  });

  // Flashcards
  createFolder("Flashcards", container => {
    studyData.forEach(entry => {
      const author = extractAuthors(entry.topics);
      const item = document.createElement("div");
      item.className = "file-item";
      item.style.whiteSpace = "normal";
      item.style.padding = "6px 8px";
      item.innerHTML = `Day ${entry.day} (${author})`;
      item.addEventListener("click", () => { showFlashcardsIndex(); loadFlashcards(entry.day, true); });
      container.appendChild(item);
    });
  });

  // Authors
  const authorSplitExceptions = { "Day16": [4], "Day45": [4], "Day46": [10] };
  createFolder("Authors", container => {
    const authorMap = {};
    async function processAuthor(dayEntry){
      try{
        const res = await fetch(`flashcards/day${dayEntry.day}.txt`);
        if(!res.ok) return;
        const txt = await res.text();
        const lines = txt.split("\n").filter(l=>l.trim()&&!l.startsWith("#"));
        if(!lines.length) return;
        const authors = [...extractAuthors(dayEntry.topics).split("+")];
        let splitCounts = authorSplitExceptions[`Day${dayEntry.day}`];
        let startIdx = 0;
        for(let i=0;i<authors.length;i++){
          const author = authors[i];
          const count = splitCounts?.[i] ?? (i===authors.length-1 ? lines.length-startIdx : 0);
          for(let j=startIdx;j<startIdx+count;j++){
            if(!authorMap[author]) authorMap[author]=[];
            const [title, answer] = lines[j]?.split("\t") || ["", ""];
            if(title) authorMap[author].push({day: dayEntry.day, title, answer});
          }
          startIdx+=count;
        }
      }catch{}
    }
    (async ()=>{
      for(const entry of studyData) await processAuthor(entry);
      Object.keys(authorMap).forEach(author=>{
        const item = document.createElement("div");
        item.className="file-item";
        item.style.whiteSpace="normal";
        item.textContent=author;
        item.addEventListener("click", ()=>{
          content.innerHTML=`<h2>Flashcards for ${author}</h2>`;
          const containerDiv=document.createElement("div");
          containerDiv.style.display="flex"; containerDiv.style.flexDirection="column"; containerDiv.style.gap="12px";
          content.appendChild(containerDiv);
          authorMap[author].forEach((fc,i)=>{
            const card=document.createElement("div");
            card.className="flashcard-card";
            const qDiv=document.createElement("div");
            qDiv.style.fontWeight="700"; qDiv.style.marginBottom="6px";
            qDiv.textContent=`${i+1}) Day ${fc.day}: ${fc.title}`;
            card.appendChild(qDiv);
            const aDiv=document.createElement("div");
            aDiv.className="a";
            aDiv.textContent=fc.answer;
            card.appendChild(aDiv);
            renderMathInElement(qDiv, { delimiters:[{left:"\\[", right:"\\]", display:true}] });
            card.addEventListener("click", ()=>aDiv.style.display=(aDiv.style.display==="block"?"none":"block"));
            containerDiv.appendChild(card);
          });
        });
        container.appendChild(item);
      });
    })();
  });

  // Full Study Log
  const fullContainer = document.createElement("div");
  fullContainer.id = "full-study-log";
  fullContainer.style.paddingRight = "8px";
  studyData.forEach(entry => {
    const section = document.createElement("section");
    section.className = "day-section";
    section.id = `day-${entry.day}`;
    section.innerHTML = `<h2>Day ${entry.day} — ${entry.date}</h2>`;
    const ul = document.createElement("ul");
    entry.topics.forEach(t => { const li = document.createElement("li"); li.textContent = t; ul.appendChild(li); });
    section.appendChild(ul);
    fullContainer.appendChild(section);
  });
  content.appendChild(fullContainer);

  function showFullStudyLog() { content.innerHTML=""; content.appendChild(fullContainer); content.focus(); }
  async function showFlashcardsIndex() {
    content.innerHTML = `<h2>Flashcards</h2><div id="flash-index" style="display:flex;flex-direction:column;gap:8px;"></div>`;
    const idx = document.getElementById("flash-index");
    studyData.forEach(entry => {
      const author = extractAuthors(entry.topics);
      const div = document.createElement("div");
      div.className = "file-item";
      div.style.whiteSpace = "normal";
      div.style.padding = "8px";
      div.innerHTML = `Day ${entry.day} (${author})`;
      div.addEventListener("click", () => loadFlashcards(entry.day, true));
      idx.appendChild(div);
    });
  }

  function scrollToDay(dayNumber) {
    const section = document.getElementById(`day-${dayNumber}`);
    if(!section) return;
    const contentRect = content.getBoundingClientRect();
    const sectionRect = section.getBoundingClientRect();
    const currentScroll = content.scrollTop;
    const sectionTop = sectionRect.top - contentRect.top + currentScroll;
    const scrollTarget = sectionTop - (content.clientHeight / 2) + (section.offsetHeight / 2);
    content.scrollTo({ top: scrollTarget, behavior:"smooth" });
  }

  async function loadFlashcards(dayNumber, replaceContent=false) {
    const path = `flashcards/day${dayNumber}.txt`;
    if(replaceContent) content.innerHTML=`<h2>Day ${dayNumber} Flashcards</h2>`;
    const parent = replaceContent ? content : document.getElementById("flash-index") || content;
    try {
      const res = await fetch(path);
      if(!res.ok) throw 0;
      const txt = await res.text();
      const lines = txt.split("\n").filter(l=>l.trim()&&!l.startsWith("#"));
      if(!lines.length){ if(replaceContent) content.innerHTML+="<p><b>Rest Day</b></p>"; return; }
      const container = document.createElement("div");
      container.style.display="flex"; container.style.flexDirection="column"; container.style.gap="12px";
      container.id=`flashcards-day-${dayNumber}`;
      parent.appendChild(container);
      lines.forEach((line,i)=>{
        const [title, answer] = line.split("\t");
        if(!title) return;
        const card = document.createElement("div");
        card.className="flashcard-card";
        const qDiv = document.createElement("div");
        qDiv.style.fontWeight="700"; qDiv.style.marginBottom="6px";
        qDiv.textContent = `${i+1}) ${title}`;
        card.appendChild(qDiv);
        const aDiv = document.createElement("div");
        aDiv.className="a";
        aDiv.textContent = answer || "";
        card.appendChild(aDiv);
        renderMathInElement(qDiv, { delimiters:[{left:"\\[", right:"\\]", display:true}] });
        card.addEventListener("click", ()=>aDiv.style.display=(aDiv.style.display==="block"?"none":"block"));
        container.appendChild(card);
      });
      if(replaceContent){
        const rect=container.getBoundingClientRect();
        const contentRect=content.getBoundingClientRect();
        const scrollTop=content.scrollTop;
        const elTop=rect.top - contentRect.top + scrollTop;
        const target = elTop - (content.clientHeight/2) + (container.offsetHeight/2);
        content.scrollTo({top:target,behavior:"smooth"});
      }
    } catch { if(replaceContent) content.innerHTML+="<p><b>Rest Day</b></p>"; }
  }

  showFullStudyLog();

  selfStudyBtn.addEventListener("click", async ()=>{
    const visible = selfStudyPage.classList.toggle("visible");
    selfStudyPage.setAttribute("aria-hidden", visible?"false":"true");
    if(visible){
      let flashcardDays=0,totalCards=0;
      for(const entry of studyData){
        try{
          const r=await fetch(`flashcards/day${entry.day}.txt`);
          if(!r.ok) continue;
          const t=await r.text();
          const lines=t.split("\n").filter(l=>l.trim()&&!l.startsWith("#"));
          if(lines.length){flashcardDays++; totalCards+=lines.length;}
        } catch{}
      }
      document.getElementById("ss-day-count").textContent=`Days self-studied: ${flashcardDays} / ${studyData.length}`;
      document.getElementById("ss-total-cards").textContent=`Total flashcards: ${totalCards}`;
      const plans=[
        {name:"Stewart's Calculus (Chapters 3-11.10)", status:"completed"},
        {name:"Lay's Linear Algebra (Chapters 1-6.1)", status:"completed"},
        {name:"Vellerman's Intro to Proofs (Chapters 1-4.5)", status:"completed"},
        {name:"Abbott's Intro to Real Analysis", status:"ongoing"},
        {name:"Friedberg's Linear Algebra", status:"planned"},
        {name:"Stewart's Calculus (Chapters 12-16)", status:"ongoing"},
        {name:"Kleppner's Classical Mechanics", status:"ongoing"},
        {name:"Python (Basics, Numpy, Pandas)", status:"planned"}
      ];
      const ssPlansDiv=document.getElementById("ss-plans");
      ssPlansDiv.innerHTML="";
      plans.forEach(p=>{
        const color=p.status==="completed"?"green":p.status==="ongoing"?"orange":"red";
        const row=document.createElement("div");
        row.style.marginBottom="10px";
        row.innerHTML=`<span class="status-square" style="background:${color}"></span>${p.name}`;
        ssPlansDiv.appendChild(row);
      });
    }
  });

  // Calendar feature
  calendarBtn.addEventListener("click", ()=>{
    calendarPage.classList.add("visible");
    calendarPage.setAttribute("aria-hidden","false");
    calendarContainer.innerHTML = "";
    const studyMap = {};
    studyData.forEach(d=>{
      studyMap[d.date] = d.day;
    });
    const firstDay = new Date(studyData[0].date);
    const lastDay = new Date();
    let current = new Date(firstDay.getFullYear(), firstDay.getMonth(), 1);
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    while(current <= lastDay){
      const monthDiv = document.createElement("div");
      monthDiv.className = "calendar-month";
      const header = document.createElement("h3");
      header.textContent = `${monthNames[current.getMonth()]} ${current.getFullYear()}`;
      monthDiv.appendChild(header);
      const grid = document.createElement("div");
      grid.className = "calendar-grid";
      const totalDays = new Date(current.getFullYear(), current.getMonth()+1,0).getDate();
      for(let d=1;d<=totalDays;d++){
        const dayDiv = document.createElement("div");
        dayDiv.className = "calendar-day";
        const dateStr = `${current.getFullYear()}-${String(current.getMonth()+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        dayDiv.textContent = d;
        if(dateStr===studyData[0].date) dayDiv.classList.add("gold");
        else if(studyMap[dateStr]) dayDiv.classList.add("green");
        else dayDiv.classList.add("red");
        if(studyMap[dateStr]){
          dayDiv.addEventListener("click", ()=>{ calendarPage.classList.remove("visible"); scrollToDay(studyMap[dateStr]); });
        }
        grid.appendChild(dayDiv);
      }
      monthDiv.appendChild(grid);
      calendarContainer.appendChild(monthDiv);
      current.setMonth(current.getMonth()+1);
    }
  });

  calendarClose.addEventListener("click", ()=>{
    calendarPage.classList.remove("visible");
    calendarPage.setAttribute("aria-hidden","true");
  });

});
</script>
</body>
</html>
