<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study Log & Flashcards</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
<style>
body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
#sidebar { width: 220px; background: #f0f0f0; padding: 16px; overflow-y: auto; box-sizing: border-box; }
#content { flex: 1; padding: 20px; overflow-y: auto; position: relative; scroll-behavior: smooth; box-sizing: border-box; }

.folder { margin-bottom: 12px; }
.folder-title { cursor: pointer; margin-bottom: 6px; font-weight: bold; user-select: none; display: flex; align-items: center; }
.folder-title::before { content: "►"; display: inline-block; width: 14px; margin-right: 6px; transition: transform 0.2s ease; }
.folder.open .folder-title::before { transform: rotate(90deg); }
.folder-content { display: none; margin-left: 6px; }
.folder.open .folder-content { display: block; }

.file-item { cursor: pointer; padding: 6px 8px; border-radius: 6px; margin-bottom: 6px; transition: background 0.14s, font-weight 0.14s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.file-item:hover { background: white; font-weight: bold; }

#self-study-btn {
  position: fixed; top: 12px; right: 12px;
  background: #222; color: #fff; border: 1px solid #555;
  padding: 8px 12px; border-radius: 6px; cursor: pointer; z-index: 1000;
}

#self-study-page {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.95); color: white;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.32s ease; z-index: 999;
  padding: 40px; box-sizing: border-box; text-align: center;
}
#self-study-page.visible { opacity: 1; pointer-events: auto; }

.status-square { display:inline-block; width:15px; height:15px; margin-right:8px; vertical-align:middle; }
section.day-section { margin-bottom: 40px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
.flashcard-card { border:1px solid #ccc; padding:10px; border-radius:6px; background:#fff; cursor:pointer; }
.flashcard-card .a { display:none; margin-top:6px; }

/* Calendar button and page */
#study-calendar-btn {
  position: fixed;
  bottom: 24px;
  left: 24px;
  padding: 12px 18px;
  font-size: 14px;
  border: none;
  border-radius: 12px;
  background: #222;
  color: #fff;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
  z-index: 1000;
}
#study-calendar-btn:hover {
  background: #444;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.5);
}
#study-calendar-btn:active {
  transform: translateY(0);
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}
#study-calendar-page { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:#fff; overflow-y:auto; padding:20px; box-sizing:border-box; z-index:998; }
#study-calendar-page h2 { margin-bottom:16px; text-align: center;}
#calendar-container { display:grid; grid-template-columns: repeat(3, 200px); justify-content: center; gap: 24px; }
</style>
</head>
<body>

<div id="sidebar"></div>
<div id="content" tabindex="0"></div>
<button id="self-study-btn">Self-Study Stats</button>

<div id="self-study-page" aria-hidden="true">
  <h1 id="ss-day-count" style="font-size:48px; margin-bottom:18px;"></h1>
  <h2 id="ss-total-cards" style="font-size:32px; margin-bottom:28px;"></h2>
  <div id="ss-plans" style="font-size:18px; max-width:760px;"></div>
</div>

<!-- Calendar -->
<button id="study-calendar-btn">Calendar</button>
<div id="study-calendar-page">
  <h2>Study Calendar</h2>
  <div id="calendar-container"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const sidebar = document.getElementById("sidebar");
  const content = document.getElementById("content");
  const selfStudyBtn = document.getElementById("self-study-btn");
  const selfStudyPage = document.getElementById("self-study-page");
  const calendarBtn = document.getElementById("study-calendar-btn");
  const calendarPage = document.getElementById("study-calendar-page");
  const calendarContainer = document.getElementById("calendar-container");

  const studyData = await fetch("study_log.json").then(r => r.json());
  const knownAuthors = ["Stewart","Lay","Velleman","Abbott","Friedberg","Kleppner","Morin"];
  const authorColors = {"Stewart": "#FF8C00","Lay": "#15e6cde6","Velleman": "#a7f208db","Abbott": "#7d07fadb","Friedberg": "#0a5563db","Kleppner":"#d90b49f0"};
  const authorSplitExceptions = { "Day16": [4], "Day45": [4], "Day46": [10] };

  // --- Preload all flashcards at once ---
  const flashcardsCache = {};
  await Promise.all(studyData.map(async entry => {
    try {
      const res = await fetch(`flashcards/day${entry.day}.txt`);
      if(res.ok){
        const txt = await res.text();
        const lines = txt.split("\n").filter(l => l.trim() && !l.startsWith("#"));
        flashcardsCache[entry.day] = lines.map(l => {
          const [title, answer] = l.split("\t");
          return { title, answer };
        });
      } else flashcardsCache[entry.day] = [];
    } catch {
      flashcardsCache[entry.day] = [];
    }
  }));

  function extractAuthors(topics) {
    const authors = new Set();
    for (const t of topics) {
      for (const k of knownAuthors) {
        if (new RegExp("\\b"+k.replace(/[:]/g,"")+"\\b","i").test(t)) authors.add(k);
      }
    }
    return authors.size ? [...authors].join("+") : "<b>Rest Day</b>";
  }

  // --- BUILD AUTHOR MAP FIRST ---
  const authorMap = {};
  studyData.forEach(entry => {
    const authors = extractAuthors(entry.topics).split("+");
    const lines = flashcardsCache[entry.day];
    let splitCounts = authorSplitExceptions[`Day${entry.day}`];
    let startIdx = 0;
    for(let i=0;i<authors.length;i++){
      const author = authors[i];
      const count = splitCounts?.[i] ?? (i===authors.length-1 ? lines.length-startIdx : 0);
      for(let j=startIdx;j<startIdx+count;j++){
        if(!authorMap[author]) authorMap[author]=[];
        const fc = lines[j]; if(!fc) continue;
        authorMap[author].push({day: entry.day, title: fc.title, answer: fc.answer});
      }
      startIdx += count;
    }
  });

  function createFolder(titleText, listItemsFunc) {
    const folder = document.createElement("div");
    folder.className = "folder";
    const title = document.createElement("div");
    title.className = "folder-title";
    title.textContent = titleText;
    folder.appendChild(title);
    const contentDiv = document.createElement("div");
    contentDiv.className = "folder-content";
    folder.appendChild(contentDiv);
    sidebar.appendChild(folder);
    title.addEventListener("click", () => folder.classList.toggle("open"));
    listItemsFunc(contentDiv);
  }

  // Study Log
  createFolder("Study Log", container => {
    studyData.forEach(entry => {
      const item = document.createElement("div");
      item.className = "file-item";
      item.textContent = `Day ${entry.day} — ${entry.date}`;
      item.addEventListener("click", () => { showFullStudyLog(); scrollToDay(entry.day); });
      container.appendChild(item);
    });
  });

  // Flashcards
  createFolder("Flashcards", container => {
    studyData.forEach(entry => {
      const author = extractAuthors(entry.topics);
      const item = document.createElement("div");
      item.className = "file-item";
      item.style.whiteSpace = "normal";
      item.style.padding = "6px 8px";
      item.innerHTML = `Day ${entry.day} (${author})`;
      item.addEventListener("click", () => { showFlashcardsIndex(); loadFlashcards(entry.day, true); });
      container.appendChild(item);
    });
  });

  // Random Flashcards
  createFolder("Random Flashcards", container => {
    const wrapper = document.createElement("div");
  
    const numberLabel = document.createElement("label");
    numberLabel.textContent = "Number of flashcards: ";
    const numberSelect = document.createElement("select");
    for (let i = 1; i <= 10; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      numberSelect.appendChild(opt);
    }
    numberLabel.appendChild(numberSelect);
    wrapper.appendChild(numberLabel);
    wrapper.appendChild(document.createElement("br"));
    wrapper.appendChild(document.createElement("br"));
  
    // Use authors from authorMap (only authors with flashcards)
    const authorDiv = document.createElement("div");
    Object.keys(authorMap).forEach(author => {
      const label = document.createElement("label");
      label.style.display = "block";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = author;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(" " + author));
      authorDiv.appendChild(label);
    });
    wrapper.appendChild(authorDiv);
    wrapper.appendChild(document.createElement("br"));
  
    const genBtn = document.createElement("button");
    genBtn.textContent = "Generate Random Flashcards";
    genBtn.style.padding = "6px 12px";
    genBtn.style.cursor = "pointer";
    wrapper.appendChild(genBtn);
    container.appendChild(wrapper);
  
    genBtn.addEventListener("click", () => {
      content.innerHTML = "<h2>Random Flashcards</h2>";
      const selectedNumber = parseInt(numberSelect.value);
      const selectedAuthors = Array.from(authorDiv.querySelectorAll("input:checked")).map(c => c.value);
      let allFlashcards = [];
      studyData.forEach(entry => {
        const authorsOfDay = extractAuthors(entry.topics).split("+").map(a => a.trim());
        if (selectedAuthors.length && !authorsOfDay.some(a => selectedAuthors.includes(a))) return;
        allFlashcards.push(...flashcardsCache[entry.day]);
      });
  
      // shuffle
      for (let i = allFlashcards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allFlashcards[i], allFlashcards[j]] = [allFlashcards[j], allFlashcards[i]];
      }
  
      const selected = allFlashcards.slice(0, selectedNumber);
      const box = document.createElement("div");
      box.style.display = "flex";
      box.style.flexDirection = "column";
      box.style.gap = "12px";
      selected.forEach((fc, i) => {
        const card = document.createElement("div");
        card.className = "flashcard-card";
        const q = document.createElement("div");
        q.style.fontWeight = "700"; q.style.marginBottom = "6px";
        q.innerHTML = `${i+1}) ${fc.title}`;
        const a = document.createElement("div");
        a.className = "a";
        a.innerHTML = fc.answer || "";
        card.appendChild(q); card.appendChild(a);
        renderMathInElement(q, { delimiters:[
          {left:"\\[", right:"\\]", display:true},{left:"\\(", right:"\\)", display:false}
        ]});
        renderMathInElement(a, { delimiters:[
          {left:"\\[", right:"\\]", display:true},{left:"\\(", right:"\\)", display:false}
        ]});
        card.addEventListener("click", ()=>a.style.display=a.style.display==="block"?"none":"block");
        box.appendChild(card);
      });
      content.appendChild(box);
    });
  });

  // Authors
  createFolder("Authors", container => {
    Object.keys(authorMap).forEach(author=>{
      const item = document.createElement("div");
      item.className="file-item";
      item.style.whiteSpace="normal";
      item.textContent=author;
      item.addEventListener("click", ()=>{
        content.innerHTML=`<h2>Flashcards for ${author}</h2>`;
        const containerDiv=document.createElement("div");
        containerDiv.style.display="flex"; containerDiv.style.flexDirection="column"; containerDiv.style.gap="12px";
        content.appendChild(containerDiv);
        authorMap[author].forEach((fc,i)=>{
          const card=document.createElement("div");
          card.className="flashcard-card";
          const qDiv=document.createElement("div");
          qDiv.style.fontWeight="700"; qDiv.style.marginBottom="6px";
          qDiv.innerHTML=`${i+1}) Day ${fc.day}: ${fc.title}`;
          const aDiv=document.createElement("div");
          aDiv.className="a";
          aDiv.innerHTML=fc.answer||"";
          card.appendChild(qDiv); card.appendChild(aDiv);
          renderMathInElement(qDiv, { delimiters:[{left:"\\[", right:"\\]", display:true},{left:"\\(", right:"\\)", display:false}] });
          renderMathInElement(aDiv, { delimiters:[{left:"\\[", right:"\\]", display:true},{left:"\\(", right:"\\)", display:false}] });
          card.addEventListener("click", ()=>aDiv.style.display=aDiv.style.display==="block"?"none":"block");
          containerDiv.appendChild(card);
        });
      });
      container.appendChild(item);
    });
  });

  // --- FULL STUDY LOG ---
  const fullContainer = document.createElement("div");
  fullContainer.id = "full-study-log";
  fullContainer.style.paddingRight = "8px";

  studyData.forEach(entry => {
    const section = document.createElement("section");
    section.className = "day-section";
    section.id = `day-${entry.day}`;
    section.style.position = "relative"; // ensure that button can be absolute inside

    section.innerHTML = `<h2>Day ${entry.day} — ${entry.date}</h2>`;
    const ul = document.createElement("ul");
    entry.topics.forEach(t => {
      const li = document.createElement("li");
      li.textContent = t;
      ul.appendChild(li);
    });
    section.appendChild(ul);

    // --- FLASHCARDS TRANSITION BUTTON ---
    const btn = document.createElement("button");
    btn.innerHTML = "&#9654;"; // triangular arrow symbol
    btn.style.position = "absolute";
    btn.style.bottom = "8px";
    btn.style.right = "8px";
    btn.style.width = "36px";
    btn.style.height = "36px";
    btn.style.borderRadius = "50%";
    btn.style.border = "none";
    btn.style.background = "#222";
    btn.style.color = "#fff";
    btn.style.cursor = "pointer";
    btn.style.fontSize = "18px";
    btn.style.display = "flex";
    btn.style.alignItems = "center";
    btn.style.justifyContent = "center";
    btn.style.boxShadow = "0 2px 6px rgba(0,0,0,0.4)";
    btn.style.transition = "transform 0.15s, box-shadow 0.15s";
    btn.addEventListener("mouseenter", () => { btn.style.transform = "translateY(-2px)"; btn.style.boxShadow = "0 4px 10px rgba(0,0,0,0.5)"; });
    btn.addEventListener("mouseleave", () => { btn.style.transform = "translateY(0)"; btn.style.boxShadow = "0 2px 6px rgba(0,0,0,0.4)"; });
    btn.addEventListener("click", () => loadFlashcards(entry.day, true));

    section.appendChild(btn);

    fullContainer.appendChild(section);
  });

  content.appendChild(fullContainer);

  function showFullStudyLog() { content.innerHTML=""; content.appendChild(fullContainer); content.focus(); }

  async function showFlashcardsIndex() {
    content.innerHTML = `<h2>Flashcards</h2><div id="flash-index" style="display:flex;flex-direction:column;gap:8px;"></div>`;
    const idx = document.getElementById("flash-index");
    studyData.forEach(entry => {
      const author = extractAuthors(entry.topics);
      const div = document.createElement("div");
      div.className = "file-item";
      div.style.whiteSpace = "normal";
      div.style.padding = "8px";
      div.innerHTML = `Day ${entry.day} (${author})`;
      div.addEventListener("click", () => loadFlashcards(entry.day, true));
      idx.appendChild(div);
    });
  }

  function scrollToDay(dayNumber) {
    const section = document.getElementById(`day-${dayNumber}`);
    if(!section) return;
    const contentRect = content.getBoundingClientRect();
    const sectionRect = section.getBoundingClientRect();
    const currentScroll = content.scrollTop;
    const sectionTop = sectionRect.top - contentRect.top + currentScroll;
    const scrollTarget = sectionTop - (content.clientHeight / 2) + (section.offsetHeight / 2);
    content.scrollTo({ top: scrollTarget, behavior:"smooth" });
  }

  function loadFlashcards(dayNumber, replaceContent=false) {
    const lines = flashcardsCache[dayNumber] || [];
    if(replaceContent) content.innerHTML=`<h2>Day ${dayNumber} Flashcards</h2>`;
    const parent = replaceContent ? content : document.getElementById("flash-index") || content;
    if(!lines.length){ if(replaceContent) content.innerHTML+="<p><b>Rest Day</b></p>"; return; }
    const container = document.createElement("div");
    container.style.display="flex"; container.style.flexDirection="column"; container.style.gap="12px";
    container.id=`flashcards-day-${dayNumber}`;
    parent.appendChild(container);
    lines.forEach((fc,i)=>{
      const card = document.createElement("div"); card.className="flashcard-card";
      const qDiv = document.createElement("div"); qDiv.style.fontWeight="700"; qDiv.style.marginBottom="6px"; qDiv.innerHTML=`${i+1}) ${fc.title}`;
      const aDiv = document.createElement("div"); aDiv.className="a"; aDiv.innerHTML=fc.answer||"";
      card.appendChild(qDiv); card.appendChild(aDiv);
      renderMathInElement(qDiv,{delimiters:[{left:"\\[",right:"\\]",display:true},{left:"\\(",right:"\\)",display:false}]});
      renderMathInElement(aDiv,{delimiters:[{left:"\\[",right:"\\]",display:true},{left:"\\(",right:"\\)",display:false}]});
      card.addEventListener("click",()=>aDiv.style.display=aDiv.style.display==="block"?"none":"block");
      container.appendChild(card);
    });
    if(replaceContent){
      const rect=container.getBoundingClientRect();
      const contentRect=content.getBoundingClientRect();
      const scrollTop=content.scrollTop;
      const elTop=rect.top - contentRect.top + scrollTop;
      const target = elTop - (content.clientHeight/2) + (container.offsetHeight/2);
      content.scrollTo({top:target,behavior:"smooth"});
    }
  }

  showFullStudyLog();

  selfStudyBtn.addEventListener("click", ()=>{
    const visible = selfStudyPage.classList.toggle("visible");
    selfStudyPage.setAttribute("aria-hidden", visible?"false":"true");
    if(visible){
      let flashcardDays=0,totalCards=0;
      for(const entry of studyData){
        const lines = flashcardsCache[entry.day] || [];
        if(lines.length){flashcardDays++; totalCards+=lines.length;}
      }
      document.getElementById("ss-day-count").textContent=`Days self-studied: ${flashcardDays} / ${studyData.length}`;
      document.getElementById("ss-total-cards").textContent=`Total flashcards: ${totalCards}`;
      const plans=[
        {name:"Stewart's Calculus (Current Section: 14.3)", status:"ongoing"},
        {name:"Lay's Linear Algebra (Paused Section: 6.1)", status:"paused"},
        {name:"Vellerman's Intro to Proofs (Final Section: 4.5)", status:"completed"},
        {name:"Abbott's Intro to Real Analysis (Paused Section: 4.6)", status:"paused"},
        {name:"Friedberg's Linear Algebra (Current Section: 4.1", status:"ongoing"},
        {name:"Kleppner's Classical Mechanics (Current Section: 6.6)", status:"ongoing"},
        {name:"Morin's Introduction to Classical Mechanics", status:"planned"},
        {name:"Boyce's Differential Equations", status:"planned"},
        {name:"Python (Basics, Numpy, Pandas)", status:"planned"}
      ];
      const ssPlansDiv=document.getElementById("ss-plans");
      ssPlansDiv.innerHTML="";
      plans.forEach(p=>{
        const color=p.status==="completed"?"green":p.status==="ongoing"?"orange":p.status==="paused"?"gray":"red";
        const row=document.createElement("div"); row.style.marginBottom="10px";
        row.innerHTML=`<span class="status-square" style="background:${color}"></span>${p.name}`;
        ssPlansDiv.appendChild(row);
      });
    }
  });

  calendarBtn.addEventListener("click", async () => {
    if(calendarPage.style.display==="none"||calendarPage.style.display===""){ calendarPage.style.display="block"; await generateCalendar(); }
    else calendarPage.style.display="none";
  });

  async function generateCalendar() {
      if(calendarContainer.children.length) return;
      if(!studyData.length) return;

      // Build map of date -> flashcard count
      const flashcardMap = {};
      let minCount = Infinity, maxCount = -Infinity;
      studyData.forEach(entry => {
          const count = (flashcardsCache[entry.day] || []).length;
          flashcardMap[entry.date] = count;
          if(count > 0) { minCount = Math.min(minCount, count); maxCount = Math.max(maxCount, count); }
      });
      if(minCount === Infinity) minCount = 0;
      if(maxCount === -Infinity) maxCount = 1;

      const firstStudyDate = studyData[0].date.split(".").reverse().join("-");
      const firstStudy = new Date(firstStudyDate);
      const today = new Date();
      let current = new Date(firstStudy.getFullYear(), firstStudy.getMonth(), 1);
      const months = [];
      while(current <= today){ months.push(new Date(current)); current.setMonth(current.getMonth()+1); }

      calendarContainer.style.display = "grid";
      calendarContainer.style.gridTemplateColumns = "repeat(3, 200px)";
      calendarContainer.style.justifyItems = "center";
      calendarContainer.style.columnGap = "200px"; // horizontal gap between months
      calendarContainer.style.rowGap = "100px";    // vertical gap between rows of months


      months.forEach(monthDate => {
          const monthBlock = document.createElement("div");
          monthBlock.style.display = "flex";
          monthBlock.style.flexDirection = "column";
          monthBlock.style.alignItems = "center";

          const title = document.createElement("div");
          title.style.fontWeight = "bold";
          title.style.marginBottom = "16px";
          title.textContent = monthDate.toLocaleString('default',{ month:'long', year:'numeric' });
          monthBlock.appendChild(title);

          const daysGrid = document.createElement("div");
          daysGrid.style.display="grid";
          daysGrid.style.gridTemplateColumns="repeat(7,32px)";
          daysGrid.style.gap="8px";
          daysGrid.style.justifyContent="center";

          const year = monthDate.getFullYear();
          const month = monthDate.getMonth();
          const firstDay = new Date(year,month,1).getDay();
          for(let i=0;i<firstDay;i++) daysGrid.appendChild(document.createElement("div"));

          const daysInMonth = new Date(year,month+1,0).getDate();
          for(let day=1; day<=daysInMonth; day++){
              const cell = document.createElement("div");
              cell.style.width="32px";
              cell.style.height="32px";
              cell.style.lineHeight="32px";
              cell.style.textAlign="center";
              cell.style.borderRadius="50%";
              cell.style.fontWeight="700";

              const dateStr = `${String(day).padStart(2,"0")}.${String(month+1).padStart(2,"0")}.${year}`;
              const entry = studyData.find(e=>e.date===dateStr);
              const dateObj = new Date(year, month, day);
              cell.textContent = day;

              if(dateObj < firstStudy || dateObj > today){
                  cell.style.background="#ccc";
                  cell.style.color="#666";
              } else if(entry){
                  const count = flashcardMap[dateStr];
                  if(count > 0){
                      const t = (count - minCount) / (maxCount - minCount || 1);
                      const greenValue = Math.round(70 + t * 155);
                      cell.style.background = `rgb(0,${greenValue},0)`;
                  } else{
                      cell.style.background = "red";
                  }
                  cell.style.color="#000";
                  cell.style.cursor="pointer";

                  // Add thin rings for all authors
                  const authors = extractAuthors(entry.topics).split("+").map(a => a.trim());
                  if(authors.length && authors[0] !== "<b>Rest Day</b>") {
                      const borderWidth = 2;
                      const step = 2; // distance between rings
                      const shadows = authors.map((a,i)=>{
                          const color = authorColors[a] || "black";
                          const offset = borderWidth + i*step;
                          return `0 0 0 ${offset}px ${color}`;
                      });
                      cell.style.boxShadow = shadows.join(", ");
                      cell.style.borderRadius = "50%";
                  }

                  cell.addEventListener("click", ()=>{
                      showFullStudyLog();
                      scrollToDay(entry.day);
                      calendarPage.style.display = "none";
                  });

              } else {
                  cell.style.background="#fff";
                  cell.style.color="#000";
              }

              daysGrid.appendChild(cell);
          }

          monthBlock.appendChild(daysGrid);
          calendarContainer.appendChild(monthBlock);
      });

      // --- AUTHOR LEGEND ---
      let legend = document.getElementById("author-legend");
      if(!legend){
          legend = document.createElement("div");
          legend.id = "author-legend";
          legend.style.position = "fixed";
          legend.style.top = "60px"; // below the self-study button (button is 12px from top + 48px height)
          legend.style.left = "12px";
          legend.style.display = "flex";
          legend.style.flexDirection = "column";
          legend.style.gap = "8px";
          calendarPage.appendChild(legend);
      }
      legend.innerHTML = "";

      // Count days per author
      const authorDayCounts = {};
      studyData.forEach(entry => {
          const authors = extractAuthors(entry.topics).split("+").map(a => a.trim());
          authors.forEach(a => {
              if(a !== "<b>Rest Day</b>") {
                  if(!authorDayCounts[a]) authorDayCounts[a] = new Set();
                  authorDayCounts[a].add(entry.day);
              }
          });
      });

      Object.keys(authorColors).forEach(author => {
          const dayCount = authorDayCounts[author]?.size || 0;
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.alignItems = "center";

          const circle = document.createElement("div");
          circle.style.width = "16px";
          circle.style.height = "16px";
          circle.style.borderRadius = "50%";
          circle.style.background = authorColors[author];
          circle.style.marginRight = "8px";
          row.appendChild(circle);

          const label = document.createElement("div");
          label.textContent = `${author} (${dayCount} Days)`;
          row.appendChild(label);

          legend.appendChild(row);
      });

  }
});
</script>
</body>
</html>

