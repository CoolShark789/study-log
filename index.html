<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study Log & Flashcards</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
<style>
body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
#sidebar { width: 220px; background: #f0f0f0; padding: 16px; overflow-y: auto; box-sizing: border-box; }
#content { flex: 1; padding: 20px; overflow-y: auto; position: relative; scroll-behavior: smooth; box-sizing: border-box; }

.folder { margin-bottom: 12px; }
.folder-title { cursor: pointer; margin-bottom: 6px; font-weight: bold; user-select: none; display: flex; align-items: center; }
.folder-title::before { content: "►"; display: inline-block; width: 14px; margin-right: 6px; transition: transform 0.2s ease; }
.folder.open .folder-title::before { transform: rotate(90deg); }
.folder-content { display: none; margin-left: 6px; }
.folder.open .folder-content { display: block; }

.file-item { cursor: pointer; padding: 6px 8px; border-radius: 6px; margin-bottom: 6px; transition: background 0.14s, font-weight 0.14s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.file-item:hover { background: white; font-weight: bold; }

#self-study-btn {
  position: fixed; top: 12px; right: 12px;
  background: #222; color: #fff; border: 1px solid #555;
  padding: 8px 12px; border-radius: 6px; cursor: pointer; z-index: 1000;
}

#self-study-page {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.95); color: white;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.32s ease; z-index: 999;
  padding: 40px; box-sizing: border-box; text-align: center;
}
#self-study-page.visible { opacity: 1; pointer-events: auto; }

.status-square { display:inline-block; width:15px; height:15px; margin-right:8px; vertical-align:middle; }
section.day-section { margin-bottom: 40px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
.flashcard-card { border:1px solid #ccc; padding:10px; border-radius:6px; background:#fff; cursor:pointer; }
.flashcard-card .a { display:none; margin-top:6px; }

/* Calendar button and page */
#study-calendar-btn {
  position: fixed;
  bottom: 24px;
  left: 24px;
  padding: 12px 18px;
  font-size: 14px;
  border: none;
  border-radius: 12px;
  background: #222;
  color: #fff;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
  z-index: 1000;
}
#study-calendar-btn:hover {
  background: #444;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.5);
}
#study-calendar-btn:active {
  transform: translateY(0);
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}
#study-calendar-page { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:#fff; overflow-y:auto; padding:20px; box-sizing:border-box; z-index:998; }
#study-calendar-page h2 { margin-bottom:16px; text-align: center;}
.month-grid { margin-bottom: 32px; }
.month-grid h3 { margin-bottom: 12px; text-align: center; }
.days-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; justify-items: center; }
.day-box { border: 1px solid #ccc; border-radius: 6px; padding: 8px; text-align: center; background: #f7f7f7; width: 80px; }
.day-box span.date { font-weight: bold; display: block; margin-bottom: 4px; }
</style>
</head>
<body>

<div id="sidebar"></div>
<div id="content" tabindex="0"></div>
<button id="self-study-btn">Self-Study Stats</button>

<div id="self-study-page" aria-hidden="true">
  <h1 id="ss-day-count" style="font-size:48px; margin-bottom:18px;"></h1>
  <h2 id="ss-total-cards" style="font-size:32px; margin-bottom:28px;"></h2>
  <div id="ss-plans" style="font-size:18px; max-width:760px;"></div>
</div>

<!-- Calendar -->
<button id="study-calendar-btn">Calendar</button>
<div id="study-calendar-page">
  <h2>Study Calendar</h2>
  <div id="calendar-container"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const sidebar = document.getElementById("sidebar");
  const content = document.getElementById("content");
  const selfStudyBtn = document.getElementById("self-study-btn");
  const selfStudyPage = document.getElementById("self-study-page");
  const calendarBtn = document.getElementById("study-calendar-btn");
  const calendarPage = document.getElementById("study-calendar-page");
  const calendarContainer = document.getElementById("calendar-container");

  const studyData = await fetch("study_log.json").then(r => r.json());
  const knownAuthors = ["Stewart","Lay","Velleman","Vellerman","Abbott","Friedberg","Kleppner"];
  const authorSplitExceptions = { "Day16": [4], "Day45": [4], "Day46": [10] };

  function extractAuthors(topics) {
    const authors = new Set();
    for (const t of topics) {
      for (const k of knownAuthors) {
        if (new RegExp("\\b"+k.replace(/[:]/g,"")+"\\b","i").test(t)) authors.add(k);
      }
    }
    return authors.size ? [...authors].join("+") : "<b>Rest Day</b>";
  }

  function createFolder(titleText, listItemsFunc) {
    const folder = document.createElement("div");
    folder.className = "folder";
    const title = document.createElement("div");
    title.className = "folder-title";
    title.textContent = titleText;
    folder.appendChild(title);
    const contentDiv = document.createElement("div");
    contentDiv.className = "folder-content";
    folder.appendChild(contentDiv);
    sidebar.appendChild(folder);
    title.addEventListener("click", () => folder.classList.toggle("open"));
    listItemsFunc(contentDiv);
  }

  const flashcardsByDay = {};
  await Promise.all(studyData.map(async entry => {
    try {
      const res = await fetch(`flashcards/day${entry.day}.txt`);
      if(!res.ok) return;
      const txt = await res.text();
      const lines = txt.split("\n").filter(l=>l.trim()&&!l.startsWith("#"));
      flashcardsByDay[entry.day] = lines.map(l=>{
        const [title, answer] = l.split("\t");
        return title ? { title, answer } : null;
      }).filter(Boolean);
    } catch {}
  }));

  const authorsByDay = {};
  studyData.forEach(entry => {
    authorsByDay[entry.day] = extractAuthors(entry.topics).split("+").map(a=>a.trim());
  });

  function renderFlashcards(cards){
    const box = document.createElement("div");
    box.style.display="flex";
    box.style.flexDirection="column";
    box.style.gap="12px";
    cards.forEach((fc,i)=>{
      const card=document.createElement("div");
      card.className="flashcard-card";
      const qDiv=document.createElement("div");
      qDiv.style.fontWeight="700"; qDiv.style.marginBottom="6px";
      qDiv.innerHTML=`${i+1}) ${fc.title}`;
      card.appendChild(qDiv);
      const aDiv=document.createElement("div");
      aDiv.className="a";
      aDiv.innerHTML=fc.answer||"";
      card.appendChild(aDiv);
      renderMathInElement(qDiv,{delimiters:[{left:"\\[",right:"\\]",display:true},{left:"\\(",right:"\\)",display:false}]});
      renderMathInElement(aDiv,{delimiters:[{left:"\\[",right:"\\]",display:true},{left:"\\(",right:"\\)",display:false}]});
      card.addEventListener("click",()=>aDiv.style.display=aDiv.style.display==="block"?"none":"block");
      box.appendChild(card);
    });
    content.appendChild(box);
  }

  // Folders: Study Log, Flashcards, Random Flashcards, Authors
  createFolder("Study Log", container => {
    studyData.forEach(entry => {
      const item = document.createElement("div");
      item.className = "file-item";
      item.textContent = `Day ${entry.day} — ${entry.date}`;
      item.addEventListener("click", () => { showFullStudyLog(); scrollToDay(entry.day); });
      container.appendChild(item);
    });
  });

  createFolder("Flashcards", container => {
    studyData.forEach(entry => {
      const author = extractAuthors(entry.topics);
      const item = document.createElement("div");
      item.className = "file-item";
      item.style.whiteSpace = "normal";
      item.style.padding = "6px 8px";
      item.innerHTML = `Day ${entry.day} (${author})`;
      item.addEventListener("click", () => { showFlashcardsIndex(); loadFlashcards(entry.day, true); });
      container.appendChild(item);
    });
  });

  createFolder("Random Flashcards", container => {
    const wrapper = document.createElement("div");
    const numberLabel = document.createElement("label");
    numberLabel.textContent = "Number of flashcards: ";
    const numberSelect = document.createElement("select");
    for(let i=1;i<=10;i++){
      const opt = document.createElement("option");
      opt.value=i; opt.textContent=i;
      numberSelect.appendChild(opt);
    }
    numberLabel.appendChild(numberSelect);
    wrapper.appendChild(numberLabel);
    wrapper.appendChild(document.createElement("br"));
    wrapper.appendChild(document.createElement("br"));
    const authorDiv = document.createElement("div");
    knownAuthors.forEach(author=>{
      const label=document.createElement("label");
      label.style.display="block";
      const checkbox=document.createElement("input");
      checkbox.type="checkbox"; checkbox.value=author;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(" "+author));
      authorDiv.appendChild(label);
    });
    wrapper.appendChild(authorDiv);
    wrapper.appendChild(document.createElement("br"));
    const genBtn=document.createElement("button");
    genBtn.textContent="Generate Random Flashcards";
    genBtn.style.padding="6px 12px"; genBtn.style.cursor="pointer";
    wrapper.appendChild(genBtn);
    container.appendChild(wrapper);

    genBtn.addEventListener("click", ()=>{
      content.innerHTML="<h2>Random Flashcards</h2>";
      const selectedNumber=parseInt(numberSelect.value);
      const selectedAuthors=Array.from(authorDiv.querySelectorAll("input:checked")).map(c=>c.value);
      let allFlashcards=[];
      studyData.forEach(entry=>{
        const day=entry.day;
        if(selectedAuthors.length && !authorsByDay[day].some(a=>selectedAuthors.includes(a))) return;
        allFlashcards.push(...(flashcardsByDay[day]||[]));
      });
      if(!selectedAuthors.length && allFlashcards.length===0)
        allFlashcards = Object.values(flashcardsByDay).flat();
      for(let i=allFlashcards.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [allFlashcards[i], allFlashcards[j]]=[allFlashcards[j], allFlashcards[i]];
      }
      renderFlashcards(allFlashcards.slice(0,selectedNumber));
    });
  });

  createFolder("Authors", container => {
    const authorMap = {};
    studyData.forEach(entry=>{
      const day=entry.day;
      authorsByDay[day].forEach(author=>{
        if(!authorMap[author]) authorMap[author]=[];
        const lines=flashcardsByDay[day]||[];
        let splitCounts=authorSplitExceptions[`Day${day}`];
        let startIdx=0;
        const authors=authorsByDay[day];
        for(let i=0;i<authors.length;i++){
          const a=authors[i];
          const count=splitCounts?.[i] ?? (i===authors.length-1 ? lines.length-startIdx:0);
          for(let j=startIdx;j<startIdx+count;j++){
            if(!lines[j]) continue;
            authorMap[a] = authorMap[a]||[];
            authorMap[a].push({day,title:lines[j].title,answer:lines[j].answer});
          }
          startIdx+=count;
        }
      });
    });

    Object.keys(authorMap).forEach(author=>{
      const item=document.createElement("div");
      item.className="file-item";
      item.style.whiteSpace="normal"; item.textContent=author;
      item.addEventListener("click", ()=>{
        content.innerHTML=`<h2>Flashcards for ${author}</h2>`;
        renderFlashcards(authorMap[author]);
      });
      container.appendChild(item);
    });
  });

  const fullContainer=document.createElement("div");
  fullContainer.id="full-study-log"; fullContainer.style.paddingRight="8px";
  studyData.forEach(entry=>{
    const section=document.createElement("section");
    section.className="day-section"; section.id=`day-${entry.day}`;
    section.innerHTML=`<h2>Day ${entry.day} — ${entry.date}</h2>`;
    const ul=document.createElement("ul");
    entry.topics.forEach(t=>{ const li=document.createElement("li"); li.textContent=t; ul.appendChild(li); });
    section.appendChild(ul);
    fullContainer.appendChild(section);
  });
  content.appendChild(fullContainer);

  function showFullStudyLog(){ content.innerHTML=""; content.appendChild(fullContainer); content.focus(); }

  async function showFlashcardsIndex() {
    content.innerHTML=`<h2>Flashcards</h2><div id="flash-index" style="display:flex;flex-direction:column;gap:8px;"></div>`;
    const idx=document.getElementById("flash-index");
    studyData.forEach(entry=>{
      const author=extractAuthors(entry.topics);
      const div=document.createElement("div");
      div.className="file-item"; div.style.whiteSpace="normal"; div.style.padding="8px";
      div.innerHTML=`Day ${entry.day} (${author})`;
      div.addEventListener("click",()=>loadFlashcards(entry.day,true));
      idx.appendChild(div);
    });
  }

  function scrollToDay(dayNumber){
    const section=document.getElementById(`day-${dayNumber}`);
    if(!section) return;
    const contentRect=content.getBoundingClientRect();
    const sectionRect=section.getBoundingClientRect();
    const currentScroll=content.scrollTop;
    const sectionTop=sectionRect.top - contentRect.top + currentScroll;
    const scrollTarget=sectionTop - (content.clientHeight/2) + (section.offsetHeight/2);
    content.scrollTo({top:scrollTarget,behavior:"smooth"});
  }

  async function loadFlashcards(dayNumber, replaceContent=false){
    if(replaceContent) content.innerHTML=`<h2>Day ${dayNumber} Flashcards</h2>`;
    const parent=replaceContent?content:document.getElementById("flash-index")||content;
    const lines=flashcardsByDay[dayNumber]||[];
    if(!lines.length){ if(replaceContent) content.innerHTML+="<p><b>Rest Day</b></p>"; return; }
    renderFlashcards(lines.map((fc,i)=>({title:`Day ${dayNumber}: ${fc.title}`,answer:fc.answer})));
  }

  showFullStudyLog();

  selfStudyBtn.addEventListener("click", async ()=>{
    const visible=selfStudyPage.classList.toggle("visible");
    selfStudyPage.setAttribute("aria-hidden",visible?"false":"true");
    if(visible){
      const flashcardDays = Object.values(flashcardsByDay).filter(arr=>arr.length>0).length;
      const totalCards = Object.values(flashcardsByDay).reduce((a,b)=>a+b.length,0);
      document.getElementById("ss-day-count").textContent=`Days self-studied: ${flashcardDays} / ${studyData.length}`;
      document.getElementById("ss-total-cards").textContent=`Total flashcards: ${totalCards}`;
      const plans=[
        {name:"Stewart's Calculus (Chapters 3-11.10)", status:"completed"},
        {name:"Lay's Linear Algebra (Chapters 1-6.1)", status:"completed"},
        {name:"Vellerman's Intro to Proofs (Chapters 1-4.5)", status:"completed"},
        {name:"Abbott's Intro to Real Analysis", status:"ongoing"},
        {name:"Friedberg's Linear Algebra", status:"planned"},
        {name:"Stewart's Calculus (Chapters 12-16)", status:"ongoing"},
        {name:"Kleppner's Classical Mechanics", status:"ongoing"},
        {name:"Python (Basics, Numpy, Pandas)", status:"planned"}
      ];
      const ssPlansDiv=document.getElementById("ss-plans");
      ssPlansDiv.innerHTML="";
      plans.forEach(p=>{
        const sq=document.createElement("span");
        sq.className="status-square";
        sq.style.background=p.status==="completed"?"green":p.status==="ongoing"?"orange":"grey";
        const div=document.createElement("div");
        div.style.marginBottom="6px"; div.appendChild(sq);
        div.appendChild(document.createTextNode(p.name));
        ssPlansDiv.appendChild(div);
      });
    }
  });

  calendarBtn.addEventListener("click", ()=>{
    const visible = calendarPage.style.display==="block";
    calendarPage.style.display = visible?"none":"block";
    if(!visible) renderCalendar();
  });

  function renderCalendar(){
    calendarContainer.innerHTML="";
    // group by month
    const months = {};
    studyData.forEach(entry=>{
      const dateObj = new Date(entry.date);
      const monthKey = dateObj.getFullYear()+"-"+(dateObj.getMonth()+1);
      if(!months[monthKey]) months[monthKey]=[];
      months[monthKey].push(entry);
    });
    Object.keys(months).sort().forEach(monthKey=>{
      const monthDiv = document.createElement("div");
      monthDiv.className="month-grid";
      const [year, month] = monthKey.split("-");
      const h3 = document.createElement("h3");
      h3.textContent = `${new Date(year, month-1).toLocaleString("default",{month:"long"})} ${year}`;
      monthDiv.appendChild(h3);
      const daysContainer = document.createElement("div");
      daysContainer.className="days-container";
      months[monthKey].forEach(entry=>{
        const dayBox = document.createElement("div");
        dayBox.className="day-box";
        const dateSpan = document.createElement("span");
        dateSpan.className="date"; dateSpan.textContent = new Date(entry.date).getDate();
        const countDiv = document.createElement("div");
        countDiv.textContent=`Flashcards: ${(flashcardsByDay[entry.day]||[]).length}`;
        dayBox.appendChild(dateSpan); dayBox.appendChild(countDiv);
        daysContainer.appendChild(dayBox);
      });
      monthDiv.appendChild(daysContainer);
      calendarContainer.appendChild(monthDiv);
    });
  }
});
</script>

</body>
</html>
