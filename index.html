<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study Log & Flashcards</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
<style>
body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
#sidebar { width: 200px; background: #f0f0f0; padding: 20px; overflow-y: auto; }
#main { flex: 1; padding: 20px; overflow-y: auto; position: relative; }

.sidebar-folder {
  cursor: pointer;
  margin-bottom: 10px;
  transition: background 0.2s;
}
.sidebar-folder:hover {
  background: #e0e0e0;
}
.sidebar-folder .arrow { display: inline-block; width: 12px; transition: transform 0.2s; }
.sidebar-folder .arrow.open { transform: rotate(90deg); }

.sidebar-sub { display: none; margin-left: 15px; margin-bottom: 10px; }
.sidebar-day {
  cursor: pointer;
  margin-bottom: 3px;
  padding: 2px 4px;
  border-radius: 4px;
  transition: background 0.2s;
}
.sidebar-day:hover {
  background: #ddd;
}

.entry { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
.flashcard-entry { margin-bottom: 30px; border: 1px solid #aaa; padding: 15px; border-radius: 5px; }
.flashcard-question { cursor: pointer; margin-bottom: 10px; font-weight: bold; }
.flashcard-answer { display: none; margin-left: 15px; margin-bottom: 15px; }

#selfStudyBtn { position: absolute; top: 10px; right: 10px; padding: 8px 12px; background: #007bff; color: #fff; border: none; cursor: pointer; border-radius: 4px; z-index: 100; }

#self-study-page {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: #fff; padding: 50px; text-align: center; overflow-y: auto;
  opacity: 0; pointer-events: none; transition: opacity 0.5s ease; z-index: 99;
}
#self-study-page.visible { opacity: 1; pointer-events: auto; }

.status-square { display: inline-block; width: 15px; height: 15px; margin-right: 8px; vertical-align: middle; }
</style>
</head>
<body>

<div id="sidebar">
  <div class="sidebar-folder" data-target="days">
    <span class="arrow">▶</span> Days
    <div class="sidebar-sub" id="days-sub"></div>
  </div>
  <div class="sidebar-folder" data-target="flashcards">
    <span class="arrow">▶</span> Flashcards
    <div class="sidebar-sub" id="flashcards-sub"></div>
  </div>
</div>

<div id="main">
  <button id="selfStudyBtn">Self-Study Summary</button>
</div>

<div id="self-study-page">
  <h1 id="ss-day-count" style="font-size: 60px; margin-bottom: 40px;"></h1>
  <div id="ss-plans"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const main = document.getElementById("main");
  const selfStudyBtn = document.getElementById("selfStudyBtn");
  const selfStudyPage = document.getElementById("self-study-page");

  function scrollToCenter(el) {
    const mainRect = main.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const scrollTop = main.scrollTop;
    const elTop = elRect.top - mainRect.top + scrollTop;
    const scrollTarget = elTop - main.clientHeight / 2 + el.offsetHeight / 2;
    main.scrollTo({ top: scrollTarget, behavior: "smooth" });
  }

  document.querySelectorAll(".sidebar-folder").forEach(folder => {
    const arrow = folder.querySelector(".arrow");
    const sub = folder.querySelector(".sidebar-sub");
    folder.addEventListener("click", e => {
      if (e.target !== folder) return;
      const isOpen = sub.style.display === "block";
      sub.style.display = isOpen ? "none" : "block";
      arrow.classList.toggle("open", !isOpen);
    });
  });

  fetch("study_log.json")
    .then(res => res.json())
    .then(async studyData => {
      const daysSub = document.getElementById("days-sub");
      const flashcardsSub = document.getElementById("flashcards-sub");

      async function fileExists(url) {
        try {
          const res = await fetch(url, { method: "HEAD" });
          return res.ok;
        } catch {
          return false;
        }
      }

      const flashcardDays = [];
      for (let dayEntry of studyData) {
        const dayDiv = document.createElement("div");
        dayDiv.className = "entry";
        dayDiv.id = "day-" + dayEntry.day;
        const topicsHtml = dayEntry.topics.map(t => `<li>${t}</li>`).join("");
        dayDiv.innerHTML = `<h2>Day ${dayEntry.day} [${dayEntry.date}]</h2><ul>${topicsHtml}</ul>`;
        main.appendChild(dayDiv);

        // extract author from first topic
        let author = "";
        const firstTopic = dayEntry.topics[0];
        if (firstTopic && firstTopic.includes(":")) {
          author = firstTopic.split(":")[0].trim();
        }

        const sideDay = document.createElement("div");
        sideDay.className = "sidebar-day";
        sideDay.textContent = "Day " + dayEntry.day + (author ? ` (${author})` : "");
        sideDay.addEventListener("click", () => scrollToCenter(dayDiv));
        daysSub.appendChild(sideDay);

        const sideCard = document.createElement("div");
        sideCard.className = "sidebar-day";
        sideCard.textContent = "Day " + dayEntry.day;
        sideCard.addEventListener("click", async () => {
          const fc = document.getElementById("fc-day-" + dayEntry.day);
          if (fc) scrollToCenter(fc);
        });
        flashcardsSub.appendChild(sideCard);
      }

      const fcHeader = document.createElement("h1");
      fcHeader.textContent = "Flashcards";
      main.appendChild(fcHeader);

      for (let dayEntry of studyData) {
        const fcDiv = document.createElement("div");
        fcDiv.className = "flashcard-entry";
        fcDiv.id = "fc-day-" + dayEntry.day;
        const fcTitle = document.createElement("h3");
        fcTitle.textContent = `Day ${dayEntry.day} Flashcards`;
        fcDiv.appendChild(fcTitle);

        const path = `flashcards/day${dayEntry.day}.txt`;
        if (await fileExists(path)) flashcardDays.push(dayEntry.day);

        try {
          const txt = await fetch(path).then(r => { if (!r.ok) throw 0; return r.text(); });
          const lines = txt.split("\n").filter(l => l.trim() && !l.startsWith("#"));
          lines.forEach((line, index) => {
            const [title, answer] = line.split("\t");
            if (!title || !answer) return;

            const questionDiv = document.createElement("div");
            questionDiv.className = "flashcard-question";
            questionDiv.innerHTML = `${index + 1}) ${title}`;

            const answerDiv = document.createElement("div");
            answerDiv.className = "flashcard-answer";
            answerDiv.innerHTML = answer;

            questionDiv.addEventListener("click", () => {
              answerDiv.style.display = answerDiv.style.display === "block" ? "none" : "block";
            });

            fcDiv.appendChild(questionDiv);
            fcDiv.appendChild(answerDiv);

            renderMathInElement(questionDiv, { delimiters: [{ left: "\\[", right: "\\]" }] });
            renderMathInElement(answerDiv, { delimiters: [{ left: "\\[", right: "\\]" }] });
          });
        } catch {
          const msg = document.createElement("div");
          msg.textContent = "No flashcards for this day.";
          msg.style.fontStyle = "italic";
          fcDiv.appendChild(msg);
        }

        main.appendChild(fcDiv);
      }

      selfStudyBtn.addEventListener("click", () => {
        selfStudyPage.classList.toggle("visible");
        if (selfStudyPage.classList.contains("visible")) {
          document.getElementById("ss-day-count").textContent = `Days self-studied: ${flashcardDays.length}`;

          const plans = [
            {name: "Stewart's Calculus (Chapters 3-11)", status: "completed"},
            {name: "Lay's Linear Algebra (Chapters 1-6.1)", status: "completed"},
            {name: "Vellerman's Intro to Proofs", status: "ongoing"},
            {name: "Abbott's Intro to Real Analysis", status: "planned"},
            {name: "Friedberg's Real Analysis", status: "planned"},
            {name: "Stewart's Calculus (Chapters 12-16)", status: "planned"},
            {name: "Resnick's Physics (Chapters 1-20)", status: "planned"},
            {name: "Python (Basics, Numpy, Pandas)", status: "planned"}
          ];

          const ssPlansDiv = document.getElementById("ss-plans");
          ssPlansDiv.innerHTML = "";
          plans.forEach(p => {
            let color = p.status === "completed" ? "green" : p.status === "ongoing" ? "orange" : "red";
            ssPlansDiv.innerHTML += `<div style="margin-bottom:10px;"><span class="status-square" style="background:${color}"></span>${p.name}</div>`;
          });
        }
      });
    })
    .catch(err => console.error("Failed to load study log JSON:", err));
});
</script>

</body>
</html>
